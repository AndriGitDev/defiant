import { CVEItem, DataSource } from "./types";
import { fetchRecentCVEs as fetchNVDCVEs, searchCVEs as searchNVDCVEs } from "./nvdApi";
import { fetchEUVDCVEs, searchEUVDCVEs } from "./euvdApi";

/**
 * Unified API to fetch CVEs from multiple sources
 */
export async function fetchCVEsFromAllSources(
  days: number = 30,
  source: DataSource = "ALL"
): Promise<CVEItem[]> {
  const promises: Promise<CVEItem[]>[] = [];

  if (source === "ALL" || source === "NVD") {
    promises.push(fetchNVDCVEs(days));
  }

  if (source === "ALL" || source === "EUVD") {
    promises.push(fetchEUVDCVEs(days));
  }

  try {
    const results = await Promise.all(promises);
    const allCVEs = results.flat();

    // Sort by date (most recent first)
    return allCVEs.sort((a, b) =>
      new Date(b.publishedDate).getTime() - new Date(a.publishedDate).getTime()
    );
  } catch (error) {
    console.error("Error fetching CVEs from sources:", error);
    return [];
  }
}

/**
 * Search CVEs across multiple sources
 */
export async function searchCVEs(
  searchTerm: string,
  source: DataSource = "ALL"
): Promise<CVEItem[]> {
  const promises: Promise<CVEItem[]>[] = [];

  if (source === "ALL" || source === "NVD") {
    promises.push(searchNVDCVEs(searchTerm));
  }

  if (source === "ALL" || source === "EUVD") {
    promises.push(searchEUVDCVEs(searchTerm));
  }

  try {
    const results = await Promise.all(promises);
    const allCVEs = results.flat();

    // Remove duplicates (same CVE ID from different sources)
    const uniqueCVEs = allCVEs.reduce((acc, cve) => {
      const existing = acc.find((c) => c.cveId === cve.cveId);
      if (!existing) {
        acc.push(cve);
      } else if (cve.source === "NVD" && existing.source === "EUVD") {
        // Prefer NVD data as primary source
        const index = acc.indexOf(existing);
        acc[index] = cve;
      }
      return acc;
    }, [] as CVEItem[]);

    return uniqueCVEs.sort((a, b) =>
      new Date(b.publishedDate).getTime() - new Date(a.publishedDate).getTime()
    );
  } catch (error) {
    console.error("Error searching CVEs:", error);
    return [];
  }
}

/**
 * Get statistics from CVE data
 */
export function getCVEStats(cves: CVEItem[]) {
  const stats = {
    totalCVEs: cves.length,
    critical: cves.filter((c) => c.severity === "CRITICAL").length,
    high: cves.filter((c) => c.severity === "HIGH").length,
    medium: cves.filter((c) => c.severity === "MEDIUM").length,
    low: cves.filter((c) => c.severity === "LOW").length,
    lastUpdated: new Date().toISOString(),
    bySource: {
      nvd: cves.filter((c) => c.source === "NVD").length,
      euvd: cves.filter((c) => c.source === "EUVD").length,
    },
  };

  return stats;
}
